<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Registro de Tiempo - Pharmadix</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }
        
        .container-custom {
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
        }
        
        @media (min-width: 768px) {
            .container-custom {
                max-width: 1200px;
                padding: 20px;
            }
            body {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            background: #ffffff;
            margin-bottom: 15px;
        }
        
        .welcome-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 0 0 20px 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        @media (min-width: 768px) {
            .welcome-header {
                border-radius: 20px;
            }
        }
        
        .nav-tabs {
            border-bottom: none;
            background: rgba(255,255,255,0.8);
            padding: 5px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            gap: 5px;
        }
        
        .nav-tabs .nav-link {
            flex: 1;
            text-align: center;
            border: none;
            color: #667eea;
            font-weight: 500;
            padding: 10px;
            border-radius: 10px;
            font-size: 0.9rem;
        }
        
        .nav-tabs .nav-link.active {
            background: #667eea;
            color: white;
        }
        
        .admin-stat-card {
            background: #ffffff;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border-left: 5px solid #667eea;
        }
        
        .admin-stat-card h5 {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        
        .admin-stat-card .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #343a40;
        }
        
        /* Mobile specific adjustments */
        @media (max-width: 767px) {
            .table-responsive {
                font-size: 0.8rem;
            }
            .btn {
                width: 100%;
                margin-bottom: 10px;
            }
            .d-flex.gap-2 {
                flex-direction: column;
            }
            .time-display {
                font-size: 1.8rem;
            }
        }
        
        .table {
            border-radius: 10px;
            overflow: hidden;
        }
        
        .table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .badge-custom {
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 500;
        }
        
        .alert {
            border-radius: 10px;
            border: none;
        }
        
        .time-display {
            font-size: 2.5rem;
            font-weight: 700;
            color: #667eea;
            text-align: center;
            padding: 20px;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-card card">
            <div class="card-body p-5">
                <div class="text-center">
                    <i class="fas fa-clock icon-large"></i>
                    <h2 class="mb-4">Registro de Tiempo</h2>
                    <p class="text-muted mb-4">Ingresa tus credenciales</p>
                </div>
                
                <form id="loginForm">
                    <div class="mb-3">
                        <label class="form-label">Usuario</label>
                        <input type="text" class="form-control" id="loginUsuario" required autocomplete="username">
                    </div>
                    <div class="mb-4">
                        <label class="form-label">Contraseña</label>
                        <input type="password" class="form-control" id="loginContraseña" required autocomplete="current-password">
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-sign-in-alt me-2"></i>Ingresar
                    </button>
                </form>
                
                <div id="loginError" class="alert alert-danger mt-3 hidden"></div>
            </div>
        </div>
    </div>
    
    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <div class="container-custom">
            <!-- Header -->
            <div class="welcome-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-0">Hola, <span id="userName"></span></h4>
                        <small id="userArea" class="opacity-75"></small>
                    </div>
                    <button class="btn btn-sm btn-light rounded-pill px-3" onclick="cerrarSesion()">
                        <i class="fas fa-sign-out-alt"></i> Salir
                    </button>
                </div>
            </div>
            
            <!-- Navigation Tabs -->
            <ul class="nav nav-tabs mb-4" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="registro-tab" data-bs-toggle="tab" data-bs-target="#registro" type="button">
                        <i class="fas fa-plus-circle me-2"></i>Registrar Tiempo
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="reportes-tab" data-bs-toggle="tab" data-bs-target="#reportes" type="button">
                        <i class="fas fa-chart-bar me-2"></i>Reportes
                    </button>
                </li>
            </ul>
            
            <!-- Tab Content -->
            <div class="tab-content">
                <!-- Registro Tab -->
                <div class="tab-pane fade show active" id="registro" role="tabpanel">
                    <div class="card">
                        <div class="card-body p-4">
                            <h4 class="mb-4"><i class="fas fa-clock me-2"></i>Registro de Tiempo</h4>
                            
                            <div id="currentTime" class="time-display"></div>
                            
                            <form id="registroForm">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Fecha de Inicio</label>
                                        <input type="date" class="form-control" id="fechaEntrada" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Hora de Entrada</label>
                                        <input type="time" class="form-control" id="horaEntrada" required>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <label class="form-label">Hora de Salida</label>
                                        <input type="time" class="form-control" id="horaSalida">
                                    </div>
                                </div>
                                
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-save me-2"></i>Guardar Registro
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="marcarHoraActual('entrada')">
                                        <i class="fas fa-clock me-2"></i>Marcar Entrada Ahora
                                    </button>
                                    <button type="button" class="btn btn-danger" onclick="marcarHoraActual('salida')">
                                        <i class="fas fa-sign-out-alt me-2"></i>Marcar Salida Ahora
                                    </button>
                                </div>
                            </form>
                            
                            <div id="registroSuccess" class="alert alert-success mt-3 hidden"></div>
                            <div id="registroError" class="alert alert-danger mt-3 hidden"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Reportes Tab -->
                <div class="tab-pane fade" id="reportes" role="tabpanel">
                    <div class="card">
                        <div class="card-body p-4">
                            <h4 class="mb-4"><i class="fas fa-chart-bar me-2"></i>Reportes de Tiempo</h4>
                            
                            <!-- Admin Dashboard Summary -->
                            <div id="adminDashboard" class="row g-3 mb-4 hidden">
                                <div class="col-6 col-md-3">
                                    <div class="admin-stat-card">
                                        <h5>Total Registros</h5>
                                        <div class="value" id="statTotal">0</div>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <div class="admin-stat-card" style="border-left-color: #38ef7d;">
                                        <h5>Personal Activo</h5>
                                        <div class="value" id="statActivo">0</div>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <div class="admin-stat-card" style="border-left-color: #ff9966;">
                                        <h5>Turno Mañana</h5>
                                        <div class="value" id="statManana">0</div>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <div class="admin-stat-card" style="border-left-color: #eb3349;">
                                        <h5>Turno Tarde/Noc</h5>
                                        <div class="value" id="statResto">0</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Filtros de Reporte -->
                            <div class="row g-3 mb-4">
                                <div class="col-md-3">
                                    <label class="form-label">Hora Desde</label>
                                    <input type="time" class="form-control" id="filtroHoraDesde">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Hora Hasta</label>
                                    <input type="time" class="form-control" id="filtroHoraHasta">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Turno</label>
                                    <select class="form-control" id="filtroTurno">
                                        <option value="">Todos los turnos</option>
                                        <option value="Mañana">Mañana (06:00 - 14:00)</option>
                                        <option value="Tarde">Tarde (14:00 - 22:00)</option>
                                        <option value="Noche">Noche (22:00 - 06:00)</option>
                                    </select>
                                </div>
                                <div class="col-md-3 d-flex align-items-end">
                                    <button class="btn btn-primary w-100" onclick="cargarRegistros()">
                                        <i class="fas fa-filter me-2"></i>Filtrar
                                    </button>
                                </div>
                            </div>
                            
                            <div id="registrosTable" class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>Nombre Completo</th>
                                            <th>Usuario</th>
                                            <th>Área</th>
                                            <th>Cargo</th>
                                            <th>Fecha Inicio</th>
                                            <th>Hora Entrada</th>
                                            <th>Hora Salida</th>
                                            <th>Tiempo Laboral</th>
                                            <th>Turno</th>
                                        </tr>
                                    </thead>
                                    <tbody id="registrosBody">
                                        <tr>
                                            <td colspan="9" class="text-center">Cargando registros...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    
    <script>
        let currentUser = null;
        
        // Inicializar
        $(document).ready(function() {
            actualizarHora();
            setInterval(actualizarHora, 1000);
            
            // Login form
            $('#loginForm').on('submit', function(e) {
                e.preventDefault();
                realizarLogin();
            });
            
            // Registro form
            $('#registroForm').on('submit', function(e) {
                e.preventDefault();
                guardarRegistro();
            });
            
            // Establecer fecha actual por defecto
            const today = new Date().toISOString().split('T')[0];
            $('#fechaEntrada').val(today);
        });
        
        // Actualizar hora actual
        function actualizarHora() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const dateString = now.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            $('#currentTime').html(`<div>${timeString}</div><div style="font-size: 1rem; margin-top: 10px;">${dateString}</div>`);
        }
        
        // Realizar login
        function realizarLogin() {
            const usuario = $('#loginUsuario').val();
            const contraseña = $('#loginContraseña').val();
            
            google.script.run
                .withSuccessHandler(function(response) {
                    const res = JSON.parse(response);
                    if (res.success) {
                        currentUser = res.user;
                        mostrarApp();
                    } else {
                        $('#loginError').text(res.message).removeClass('hidden');
                    }
                })
                .withFailureHandler(function(err) {
                    $('#loginError').text('Error: ' + err).removeClass('hidden');
                })
                .login({usuario: usuario, contraseña: contraseña});
        }
        
        // Mostrar aplicación principal
        function mostrarApp() {
            $('#loginScreen').addClass('hidden');
            $('#mainApp').removeClass('hidden');
            $('#userName').text(currentUser.nombreCompleto);
            $('#userArea').text(currentUser.area);
            $('#userCargo').text(currentUser.cargo);
            
            // Mostrar dashboard si es Admin o Supervisor
            if (currentUser.rol === 'Administrador' || currentUser.rol === 'Supervisor') {
                $('#adminDashboard').removeClass('hidden');
            } else {
                $('#adminDashboard').addClass('hidden');
            }
            
            // Cargar registros si no es la primera vez
            if ($('#reportes-tab').hasClass('active')) {
                cargarRegistros();
            }
        }
        
        // Cerrar sesión
        function cerrarSesion() {
            currentUser = null;
            $('#mainApp').addClass('hidden');
            $('#loginScreen').removeClass('hidden');
            $('#loginForm')[0].reset();
            $('#loginError').addClass('hidden');
        }
        
        // Marcar hora actual
        function marcarHoraActual(tipo) {
            const now = new Date();
            const fecha = now.toISOString().split('T')[0];
            const hora = now.toTimeString().split(' ')[0].substring(0, 5);
            
            if (tipo === 'entrada') {
                $('#fechaEntrada').val(fecha);
                $('#horaEntrada').val(hora);
            } else {
                $('#horaSalida').val(hora);
            }
        }
        
        // Guardar registro
        function guardarRegistro() {
            if (!currentUser) return;
            
            const datos = {
                usuario: currentUser.usuario,
                fechaEntrada: $('#fechaEntrada').val(),
                horaEntrada: $('#horaEntrada').val(),
                horaSalida: $('#horaSalida').val()
            };
            
            google.script.run
                .withSuccessHandler(function(response) {
                    const res = JSON.parse(response);
                    if (res.success) {
                        $('#registroSuccess').text(res.message).removeClass('hidden');
                        $('#registroError').addClass('hidden');
                        $('#registroForm')[0].reset();
                        $('#fechaEntrada').val(new Date().toISOString().split('T')[0]);
                        setTimeout(() => $('#registroSuccess').addClass('hidden'), 3000);
                    } else {
                        $('#registroError').text(res.message).removeClass('hidden');
                    }
                })
                .registrarTiempo(datos);
        }
        
        // Cargar registros
        function cargarRegistros() {
            if (!currentUser) return;
            
            const filtros = {
                usuario: currentUser.usuario,
                rol: currentUser.rol,
                horaDesde: $('#filtroHoraDesde').val(),
                horaHasta: $('#filtroHoraHasta').val(),
                turno: $('#filtroTurno').val()
            };
            
            google.script.run
                .withSuccessHandler(function(response) {
                    const res = JSON.parse(response);
                    if (res.success) {
                        mostrarRegistros(res.registros);
                    } else {
                        $('#registrosBody').html('<tr><td colspan="9" class="text-center text-danger">' + res.message + '</td></tr>');
                    }
                })
                .obtenerRegistros(filtros);
        }
        
        // Mostrar registros en tabla
        function mostrarRegistros(registros) {
            if (registros.length === 0) {
                $('#registrosBody').html('<tr><td colspan="9" class="text-center">No hay registros que coincidan con los filtros</td></tr>');
                return;
            }
            
            // Calcular estadísticas para Admin
            if (currentUser.rol === 'Administrador' || currentUser.rol === 'Supervisor') {
                const total = registros.length;
                const activos = registros.filter(r => !r['Hora Salida']).length;
                const manana = registros.filter(r => r['Turno'] === 'Mañana').length;
                const resto = total - manana;
                
                $('#statTotal').text(total);
                $('#statActivo').text(activos);
                $('#statManana').text(manana);
                $('#statResto').text(resto);
            }
            
            let html = '';
            registros.forEach(function(reg) {
                html += '<tr>';
                html += '<td>' + (reg['Nombre Completo'] || '') + '</td>';
                html += '<td>' + (reg.Usuario || '') + '</td>';
                html += '<td><span class="badge badge-custom bg-primary">' + (reg.Area || '') + '</span></td>';
                html += '<td>' + (reg.Cargo || '') + '</td>';
                html += '<td>' + (reg['Fecha de Inicio'] || '') + '</td>';
                html += '<td>' + (reg['Hora Entrada'] || '') + '</td>';
                html += '<td>' + (reg['Hora Salida'] || '') + '</td>';
                html += '<td><strong>' + (reg['Tiempo Laboral'] || 'Pendiente') + '</strong></td>';
                html += '<td><span class="badge rounded-pill bg-info text-dark">' + (reg['Turno'] || '-') + '</span></td>';
                html += '</tr>';
            });
            
            $('#registrosBody').html(html);
        }
        
        // Cargar registros al cambiar a la pestaña de reportes
        $('button[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
            if (e.target.id === 'reportes-tab') {
                cargarRegistros();
            }
        });
    </script>
</body>
</html>
