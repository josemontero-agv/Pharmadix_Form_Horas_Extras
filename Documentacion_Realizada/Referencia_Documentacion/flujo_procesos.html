<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flujo de Procesos - Pharmadix Times</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav id="toc">
        <div class="nav-logo">
            <img src="assets/logo-pharmadix.png" alt="Pharmadix Logo">
        </div>
        <h2><i class="bi bi-diagram-2"></i> Flujo</h2>
        <ul>
            <li><a href="index.html"><i class="bi bi-house"></i> Inicio</a></li>
            <li><a href="manual_usuario.html"><i class="bi bi-person-workspace"></i> Manual Usuario</a></li>
            <li><a href="manual_desarrollador.html"><i class="bi bi-code-slash"></i> Manual Dev</a></li>
            <li><a href="flujo_procesos.html" class="active"><i class="bi bi-diagram-2"></i> Flujo Procesos</a></li>
            <li><a href="arquitectura.html"><i class="bi bi-diagram-3"></i> Arquitectura</a></li>
            <li><a href="informe_ejecutivo.html"><i class="bi bi-file-earmark-bar-graph"></i> Informe Técnico</a></li>
            <li><a href="stack.html"><i class="bi bi-layers"></i> Stack</a></li>
            <li><a href="bitacora.html"><i class="bi bi-journal-text"></i> Bitácora</a></li>
        </ul>
    </nav>
    <main>
        <section id="mapa-procesos">
            <h2>Mapa de Procesos Pharmadix</h2>
            <p>Visión macro del sistema de gestión de tiempos dentro de la cadena de valor de Pharmadix Corp. S.A.</p>
            
            <div class="mermaid">
            graph LR
                subgraph Estratégicos
                    E1[Gerencia TI] --- E2[Planeamiento de Producción]
                end
                
                subgraph Operativos
                    O1[Apertura de Lote] --> O2[Captura Digital QR]
                    O2 --> O3[Cierre Operativo]
                    O3 --> O4[Validación Admin]
                end
                
                subgraph Apoyo
                    S1[Recursos Humanos] --- S2[Contabilidad/Nómina]
                    S3[Auditoría Calidad ALCOA+] --- S2
                end
                
                E2 -.-> Operativos
                Operativos --> S2
                Operativos -.-> S3
            </div>
        </section>

        <h1><i class="bi bi-diagram-2-fill"></i> Flujo de Procesos v2.0</h1>
        <p>Sintetiza la operación digital del sistema bajo la arquitectura PWA.</p>

        <section id="actores">
            <h2>Actores y Sistemas</h2>
            <ul>
                <li><strong>Tomador de Tiempos:</strong> Operario encargado de registrar los tiempos de su equipo (10-20 personas).</li>
                <li><strong>PWA Frontend:</strong> Aplicación web profesional con capacidades offline.</li>
                <li><strong>Service Worker:</strong> Componente que gestiona la caché y sincronización en segundo plano.</li>
                <li><strong>Backend API:</strong> API de alto rendimiento (Fastify/Node.js).</li>
                <li><strong>Base de Datos:</strong> PostgreSQL 15+.</li>
            </ul>
        </section>

        <section id="inicio-lote">
            <h2>1. Inicio de Sesión e Ingreso de Lote</h2>
            <p>El Tomador de Tiempos registra los datos completos del lote al iniciar el turno para establecer el contexto de trabajo.</p>
            
            <div class="mermaid">
            sequenceDiagram
                participant TT as Tomador de Tiempos
                participant PWA as PWA App
                participant SW as Service Worker
                
                TT->>PWA: Inicia Nueva Hoja
                
                rect rgb(242, 241, 246)
                    Note over TT, PWA: Ingreso de Datos del Lote
                    TT->>PWA: Ingresa/Escanea Número de Lote
                    PWA->>SW: Busca Lote en Caché
                    alt Lote Existente
                        SW-->>PWA: Autocompleta Producto, Presentación, etc.
                    else Nuevo Lote
                        TT->>PWA: Selecciona Producto y Presentación
                        TT->>PWA: Selecciona Proceso y Área
                        TT->>PWA: Ingresa Cantidad Ordenada
                    end
                end
                
                TT->>PWA: Confirma creación de hoja
            </div>

            <div class="note">
                <strong>Modo Borrador:</strong> Al confirmar los datos iniciales, se crea una hoja en estado <strong>BORRADOR</strong>. Esto permite al usuario salir de la aplicación y regresar más tarde sin perder el progreso.
            </div>
        </section>

        <section id="registro-operarios">
            <h2>2. Registro Masivo con Validación de Estado</h2>
            <p>El sistema gestiona inteligentemente las transiciones de estado de cada operario para asegurar que el cálculo de horas sea exacto.</p>
            
            <div class="mermaid">
            sequenceDiagram
                participant TT as Tomador de Tiempos
                participant PWA as PWA App
                participant IDB as IndexedDB (Local)
                
                loop Por cada operario
                    TT->>PWA: Identifica Operario (QR o Manual)
                    PWA->>IDB: Consulta estado actual en esta hoja
                    
                    alt Estado: NO REGISTRADO
                        IDB-->>PWA: Estado = PENDIENTE
                        PWA-->>TT: Muestra Botón Verde "ENTRADA"
                        TT->>PWA: Clic Entrada -> Guarda Hora Inicio
                    else Estado: EN PROCESO
                        IDB-->>PWA: Estado = EN_PROCESO
                        PWA-->>TT: Muestra Botón Naranja "SALIDA"
                        TT->>PWA: Clic Salida -> Guarda Hora Fin y Calcula Total
                    else Estado: FINALIZADO
                        PWA-->>TT: Muestra Resumen (Solo Lectura)
                    end
                    
                    PWA->>IDB: Actualiza registro local
                end
            </div>

            <div class="card-grid">
                <div class="card" style="border-top: 4px solid var(--pharmadix-green);">
                    <h3>Estado: PENDIENTE</h3>
                    <p>Muestra botón <strong>"ENTRADA"</strong>. Al hacer clic, se guarda la hora de inicio exacta.</p>
                </div>
                <div class="card" style="border-top: 4px solid var(--pharmadix-orange);">
                    <h3>Estado: EN PROCESO</h3>
                    <p>Muestra botón <strong>"SALIDA"</strong>. Al hacer clic, se guarda la hora de fin y se calcula el total.</p>
                </div>
                <div class="card" style="border-top: 4px solid #999;">
                    <h3>Estado: FINALIZADO</h3>
                    <p>Muestra un resumen de solo lectura. No permite más modificaciones para asegurar la integridad.</p>
                </div>
            </div>
        </section>

        <section id="cierre-firma">
            <h2>3. Cierre con Doble Confirmación (Workflow)</h2>
            <p>Garantiza que la información enviada al backend ha sido revisada por las partes interesadas.</p>
            
            <div class="mermaid">
            sequenceDiagram
                participant TT as Tomador de Tiempos
                participant Jefe as Jefe Manufactura
                participant PWA as PWA App
                participant API as Backend API
                participant DB as Base de Datos
                
                Note over TT, PWA: Paso 1: Cierre Operativo
                TT->>PWA: Revisa totales y firma
                PWA->>API: Envía hoja (Estado: POR_APROBAR)
                API->>DB: INSERT HOJA
                
                Note over Jefe, API: Paso 2: Aprobación Administrativa
                Jefe->>PWA: Accede a Dashboard Admin
                PWA->>API: GET hojas pendientes
                Jefe->>PWA: Revisa hoja #12345
                Jefe->>PWA: Firma y Aprueba
                PWA->>API: UPDATE estado = APROBADA
                API->>DB: Commit final
            </div>

            <div class="note">
                <strong>Integridad ALCOA+:</strong> Cada firma digital vincula el ID del usuario, timestamp, IP y dispositivo utilizado.
            </div>
        </section>

        <section id="online-offline-viz">
            <h2>Mecanismo de Sincronización</h2>
            <p>La arquitectura "Offline-First" permite trabajar en zonas de baja cobertura dentro de la planta.</p>
            
            <div class="mermaid">
            flowchart TD
                A[Captura de Datos en Tablet] --> B{¿Hay Internet?}
                B -- Sí --> C[Envío inmediato vía API]
                C --> D[Confirmación en Tiempo Real]
                B -- No --> E[Guardar en IndexedDB]
                E --> F[Service Worker detecta red]
                F --> G[Sincronización en Segundo Plano]
                G --> C
            </div>
        </section>

        <section id="online-offline">
            <h2>Sincronización de Datos</h2>
            <div class="card-grid">
                <div class="card">
                    <i class="bi bi-wifi"></i>
                    <h3>Online</h3>
                    <p>Envío inmediato vía API y confirmación en tiempo real.</p>
                </div>
                <div class="card">
                    <i class="bi bi-wifi-off"></i>
                    <h3>Offline</h3>
                    <p>Guardado en IndexedDB local y sincronización automática al recuperar red.</p>
                </div>
            </div>
        </section>

        <footer style="text-align: center; margin-top: 40px; color: var(--text-muted);">
            <p>&copy; 2026 Pharmadix Corp. S.A. | Flujo de Procesos Digitales</p>
        </footer>
    </main>

    <button class="print-button" onclick="window.print()" title="Exportar a PDF">
        <i class="bi bi-file-earmark-pdf"></i>
    </button>

    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'base',
            themeVariables: {
                primaryColor: '#493c8b',
                primaryTextColor: '#ffffff',
                primaryBorderColor: '#403187',
                lineColor: '#8981b3',
                secondaryColor: '#f2f1f6',
                tertiaryColor: '#dcdae9',
                
                // Colores de texto base
                textColor: '#1A1A1A',
                mainBkg: '#ffffff',
                nodeTextColor: '#1A1A1A',
                nodeBkg: '#ffffff',
                clusterBkg: '#f2f1f6',
                clusterBorder: '#dcdae9',
                errorBkgColor: '#f8d7da',
                errorTextColor: '#721c24',
                
                // Configuración específica para Diagramas de Secuencia
                actorBkg: '#493c8b',
                actorTextColor: '#ffffff',
                actorBorder: '#403187',
                
                labelTextColor: '#1A1A1A',
                loopTextColor: '#1A1A1A',
                
                noteBkgColor: '#fff3cd',
                noteTextColor: '#493c8b',
                noteBorderColor: '#ffeeba',
                
                signalColor: '#493c8b',
                signalTextColor: '#1A1A1A',
                
                sequenceNumberColor: '#ffffff'
            }
        });
    </script>
</body>
</html>
